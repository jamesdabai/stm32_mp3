#include "global.h"
#include "dev_uart.h"
#include "hardware.h"
#include "string.h"
#include "delay.h"
#include "gpio.h"
#include "dev_gpio.h"
#include "fs_vs.h"
#include "REGISTER.H"
#include "alloc.h"
#include "drv_lcd.h"
#include "QR_Encode.h"
#include "math.h"
#include "drv_lcd_font_data.h"
#include <absacc.h>
#include "dev_api.h"
#include "dev_spi_flash.h"

#define LCD_FONT_DEBUG

#ifdef LCD_FONT_DEBUG
#define log_font    uart_printf
#else
#define log_font(...)
#endif



const char ascii_16_8[]=
{
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*" ", */
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x67, 0xfe, 0x67, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*"!",0*/
0x00, 0x00, 0x10, 0x00, 0x0c, 0x00, 0x02, 0x00, 0x10, 0x00, 0x0c, 0x00, 0x02, 0x00, 0x00, 0x00, /*""",1*/
0x00, 0x02, 0x20, 0x3f, 0xe0, 0x02, 0x3c, 0x3e, 0xa0, 0x03, 0x7c, 0x02, 0x20, 0x00, 0x00, 0x00, /*"#",2*/
0x00, 0x00, 0x78, 0x1c, 0x84, 0x20, 0xfe, 0x7f, 0x04, 0x21, 0x38, 0x1e, 0x00, 0x00, 0x00, 0x00, /*"$",3*/
0x70, 0x60, 0x88, 0x18, 0x70, 0x06, 0x80, 0x01, 0x60, 0x0e, 0x18, 0x11, 0x0c, 0x0e, 0x00, 0x00, /*"%",4*/
0x00, 0x1f, 0xf8, 0x20, 0x84, 0x23, 0x84, 0x34, 0x78, 0x0e, 0x00, 0x33, 0x00, 0x20, 0x00, 0x00, /*"&",5*/
0x10, 0x00, 0x16, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*"'",6*/
0x00, 0x00, 0x00, 0x00, 0xe0, 0x07, 0x18, 0x18, 0x04, 0x20, 0x02, 0x40, 0x00, 0x00, 0x00, 0x00, /*"(",7*/
0x00, 0x00, 0x02, 0x20, 0x04, 0x10, 0x18, 0x0c, 0xe0, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*")",8*/
0x00, 0x00, 0x40, 0x02, 0x80, 0x01, 0xf0, 0x0f, 0x80, 0x01, 0x40, 0x02, 0x00, 0x00, 0x00, 0x00, /*"*",9*/
0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0xf0, 0x07, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, /*"+",10*/
0x00, 0x40, 0x00, 0x58, 0x00, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*",",11*/
0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x00, 0x00, /*"-",12*/
0x00, 0x00, 0x00, 0x18, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*".",13*/
0x00, 0x00, 0x00, 0x30, 0x00, 0x0c, 0x80, 0x03, 0x60, 0x00, 0x1c, 0x00, 0x02, 0x00, 0x00, 0x00, /*"/",14*/
0x00, 0x00, 0xf0, 0x0f, 0x08, 0x12, 0x04, 0x21, 0x84, 0x20, 0x48, 0x10, 0xf0, 0x0f, 0x00, 0x00, /*"0",15*/    
0x00, 0x00, 0x00, 0x20, 0x10, 0x20, 0x18, 0x20, 0xfc, 0x3f, 0x00, 0x20, 0x00, 0x20, 0x00, 0x00, /*"1",16*/     
0x00, 0x00, 0x18, 0x38, 0x04, 0x24, 0x04, 0x22, 0x04, 0x21, 0x84, 0x20, 0x78, 0x30, 0x00, 0x00, /*"2",17*/
0x00, 0x00, 0x18, 0x18, 0x04, 0x20, 0x84, 0x20, 0x84, 0x20, 0x44, 0x21, 0x38, 0x1e, 0x00, 0x00, /*"3",18*/
0x00, 0x07, 0xc0, 0x04, 0x30, 0x04, 0x08, 0x24, 0xfc, 0x3f, 0x00, 0x24, 0x00, 0x00, 0x00, 0x00, /*"4",19*/
0x00, 0x00, 0xfc, 0x18, 0x84, 0x20, 0x44, 0x20, 0x44, 0x20, 0x44, 0x20, 0x8c, 0x1f, 0x00, 0x00, /*"5",20*/ 
0x00, 0x00, 0xf0, 0x1f, 0x08, 0x21, 0x84, 0x20, 0x84, 0x20, 0x84, 0x20, 0x08, 0x1f, 0x00, 0x00, /*"6",21*/
0x00, 0x00, 0x1c, 0x00, 0x04, 0x00, 0x04, 0x3f, 0xc4, 0x00, 0x34, 0x00, 0x0c, 0x00, 0x00, 0x00, /*"7",22*/
0x00, 0x00, 0x78, 0x1e, 0x84, 0x21, 0x84, 0x20, 0x84, 0x20, 0x84, 0x21, 0x78, 0x1e, 0x00, 0x00, /*"8",23*/
0x00, 0x00, 0xf8, 0x10, 0x04, 0x21, 0x04, 0x21, 0x04, 0x21, 0x84, 0x10, 0xf8, 0x0f, 0x00, 0x00, /*"9",24*/
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x18, 0xc0, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*":",25*/
0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0xc0, 0x30, 0xc0, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*";",26*/
0x00, 0x00, 0x80, 0x00, 0x40, 0x01, 0x20, 0x02, 0x10, 0x04, 0x08, 0x08, 0x04, 0x10, 0x00, 0x00, /*"<",27*/
0x40, 0x02, 0x40, 0x02, 0x40, 0x02, 0x40, 0x02, 0x40, 0x02, 0x40, 0x02, 0x40, 0x02, 0x00, 0x00, /*"=",28*/
0x00, 0x00, 0x04, 0x10, 0x08, 0x08, 0x10, 0x04, 0x20, 0x02, 0x40, 0x01, 0x80, 0x00, 0x00, 0x00, /*">",29*/
0x00, 0x00, 0x38, 0x00, 0x04, 0x00, 0x04, 0x36, 0x04, 0x37, 0x84, 0x00, 0x78, 0x00, 0x00, 0x00, /*"?",30*/
0xe0, 0x0f, 0x18, 0x10, 0xc4, 0x27, 0x24, 0x24, 0xe4, 0x23, 0x08, 0x24, 0xf0, 0x13, 0x00, 0x00, /*"@",31*/
0x00, 0x20, 0x00, 0x3e, 0xf0, 0x23, 0x0c, 0x02, 0xf0, 0x23, 0x00, 0x3e, 0x00, 0x20, 0x00, 0x00, /*"A",32*/
0x04, 0x20, 0xfc, 0x3f, 0x84, 0x20, 0x84, 0x20, 0x84, 0x20, 0x44, 0x21, 0x38, 0x1e, 0x00, 0x00, /*"B",33*/
0xe0, 0x07, 0x18, 0x18, 0x04, 0x20, 0x04, 0x20, 0x04, 0x20, 0x04, 0x10, 0x18, 0x0c, 0x00, 0x00, /*"C",34*/
0x04, 0x20, 0xfc, 0x3f, 0x04, 0x20, 0x04, 0x20, 0x04, 0x20, 0x08, 0x10, 0xf0, 0x0f, 0x00, 0x00, /*"D",35*/
0x04, 0x20, 0xfc, 0x3f, 0x84, 0x20, 0x84, 0x20, 0xe4, 0x23, 0x04, 0x20, 0x08, 0x10, 0x00, 0x00, /*"E",36*/
0x04, 0x20, 0xfc, 0x3f, 0x84, 0x20, 0x84, 0x00, 0xe4, 0x03, 0x04, 0x00, 0x08, 0x00, 0x00, 0x00, /*"F",37*/
0xf0, 0x0f, 0x08, 0x10, 0x04, 0x20, 0x04, 0x20, 0x04, 0x22, 0x0c, 0x1e, 0x10, 0x02, 0x00, 0x00, /*"G",38*/
0x04, 0x20, 0xfc, 0x3f, 0x84, 0x20, 0x80, 0x00, 0x84, 0x20, 0xfc, 0x3f, 0x04, 0x20, 0x00, 0x00, /*"H",39*/
0x00, 0x00, 0x04, 0x20, 0x04, 0x20, 0xfc, 0x3f, 0x04, 0x20, 0x04, 0x20, 0x00, 0x00, 0x00, 0x00, /*"I",40*/
0x00, 0x10, 0x00, 0x20, 0x04, 0x20, 0x04, 0x20, 0xfc, 0x1f, 0x04, 0x00, 0x04, 0x00, 0x00, 0x00, /*"J",41*/
0x04, 0x20, 0xfc, 0x3f, 0x84, 0x20, 0xc0, 0x01, 0x20, 0x26, 0x1c, 0x38, 0x04, 0x20, 0x00, 0x00, /*"K",42*/
0x04, 0x20, 0xfc, 0x3f, 0x04, 0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0x20, 0x00, 0x30, 0x00, 0x00, /*"L",43*/
0x0c, 0x20, 0xfc, 0x3f, 0x7c, 0x00, 0x80, 0x3f, 0x7c, 0x00, 0xfc, 0x3f, 0x04, 0x20, 0x00, 0x00, /*"M",44*/
0x04, 0x20, 0xfc, 0x3f, 0x3c, 0x20, 0xc0, 0x01, 0x04, 0x0e, 0xfc, 0x3f, 0x04, 0x00, 0x00, 0x00, /*"N",45*/
0xf0, 0x0f, 0x08, 0x10, 0x04, 0x20, 0x04, 0x20, 0x04, 0x20, 0x08, 0x10, 0xf0, 0x0f, 0x00, 0x00, /*"O",46*/
0x04, 0x20, 0xfc, 0x3f, 0x84, 0x20, 0x84, 0x00, 0x84, 0x00, 0x84, 0x00, 0x78, 0x00, 0x00, 0x00, /*"P",47*/
0xf0, 0x0f, 0x08, 0x10, 0x04, 0x24, 0x04, 0x24, 0x04, 0x38, 0x08, 0x70, 0xf0, 0x4f, 0x00, 0x00, /*"Q",48*/
0x04, 0x20, 0xfc, 0x3f, 0x84, 0x20, 0x84, 0x01, 0x84, 0x06, 0x78, 0x38, 0x00, 0x20, 0x00, 0x00, /*"R",49*/
0x00, 0x00, 0x78, 0x18, 0x84, 0x20, 0x84, 0x20, 0x04, 0x21, 0x04, 0x21, 0x18, 0x1e, 0x00, 0x00, /*"S",50*/ 
0x0c, 0x00, 0x04, 0x00, 0x04, 0x20, 0xfc, 0x3f, 0x04, 0x20, 0x04, 0x00, 0x0c, 0x00, 0x00, 0x00, /*"T",51*/
0x04, 0x00, 0xfc, 0x1f, 0x04, 0x20, 0x00, 0x20, 0x04, 0x20, 0xfc, 0x1f, 0x04, 0x00, 0x00, 0x00, /*"U",52*/
0x04, 0x00, 0x7c, 0x00, 0x84, 0x07, 0x00, 0x38, 0x84, 0x07, 0x7c, 0x00, 0x04, 0x00, 0x00, 0x00, /*"V",53*/
0x04, 0x00, 0xfc, 0x03, 0x00, 0x3f, 0xfc, 0x01, 0x00, 0x3f, 0xfc, 0x03, 0x04, 0x00, 0x00, 0x00, /*"W",54*/
0x04, 0x20, 0x1c, 0x38, 0x64, 0x26, 0x80, 0x01, 0x64, 0x26, 0x1c, 0x38, 0x04, 0x20, 0x00, 0x00, /*"X",55*/
0x04, 0x00, 0x3c, 0x00, 0xc4, 0x20, 0x00, 0x3f, 0xc4, 0x20, 0x3c, 0x00, 0x04, 0x00, 0x00, 0x00, /*"Y",56*/
0x00, 0x00, 0x08, 0x30, 0x04, 0x2c, 0x04, 0x23, 0xc4, 0x20, 0x34, 0x20, 0x0c, 0x30, 0x00, 0x00, /*"Z",57*/
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x3f, 0x02, 0x20, 0x02, 0x20, 0x02, 0x20, 0x00, 0x00, /*"[",58*/
0x00, 0x00, 0x0c, 0x00, 0x30, 0x00, 0xc0, 0x01, 0x00, 0x06, 0x00, 0x38, 0x00, 0x40, 0x00, 0x00, /*"\",59*/
0x00, 0x00, 0x02, 0x20, 0x02, 0x20, 0x02, 0x20, 0xfe, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*"]",60*/
0x00, 0x00, 0x08, 0x00, 0x04, 0x00, 0x02, 0x00, 0x02, 0x00, 0x04, 0x00, 0x08, 0x00, 0x00, 0x00, /*"^",61*/
0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x40, 0x00, 0x00, /*"_",62*/
0x00, 0x00, 0x02, 0x00, 0x02, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*"`",63*/
0x00, 0x00, 0x40, 0x0c, 0x20, 0x12, 0x20, 0x11, 0x20, 0x11, 0xc0, 0x1f, 0x00, 0x10, 0x00, 0x00, /*"a",64*/
0x08, 0x00, 0xf8, 0x1f, 0x00, 0x11, 0x80, 0x10, 0x80, 0x10, 0x80, 0x10, 0x00, 0x0f, 0x00, 0x00, /*"b",65*/
0x00, 0x00, 0x00, 0x07, 0x80, 0x08, 0x40, 0x10, 0x40, 0x10, 0x40, 0x10, 0x80, 0x08, 0x00, 0x00, /*"c",66*/
0x00, 0x00, 0x80, 0x0f, 0x40, 0x10, 0x40, 0x10, 0x40, 0x10, 0x48, 0x08, 0xf8, 0x1f, 0x00, 0x10, /*"d",67*/
0x00, 0x00, 0x80, 0x0f, 0x40, 0x11, 0x40, 0x11, 0x40, 0x11, 0x40, 0x11, 0x80, 0x09, 0x00, 0x00, /*"e",68*/
0x00, 0x00, 0x40, 0x10, 0x40, 0x10, 0xf0, 0x1f, 0x48, 0x10, 0x48, 0x10, 0x18, 0x00, 0x00, 0x00, /*"f",69*/
0x00, 0x00, 0x80, 0x35, 0x40, 0x4a, 0x40, 0x4a, 0x40, 0x4a, 0xc0, 0x49, 0x40, 0x30, 0x00, 0x00, /*"g",70*/
0x08, 0x10, 0xf8, 0x1f, 0x80, 0x10, 0x40, 0x00, 0x40, 0x00, 0x40, 0x10, 0x80, 0x1f, 0x00, 0x10, /*"h",71*/
0x00, 0x00, 0x40, 0x10, 0x58, 0x10, 0xd8, 0x1f, 0x00, 0x10, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, /*"i",72*/
0x00, 0x00, 0x00, 0x60, 0x00, 0x40, 0x40, 0x40, 0x58, 0x40, 0xd8, 0x3f, 0x00, 0x00, 0x00, 0x00, /*"j",73*/
0x08, 0x10, 0xf8, 0x1f, 0x00, 0x12, 0x00, 0x01, 0xc0, 0x16, 0x40, 0x18, 0x40, 0x10, 0x00, 0x00, /*"k",74*/
0x00, 0x00, 0x08, 0x10, 0x08, 0x10, 0xf8, 0x1f, 0x00, 0x10, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, /*"l",75*/
0x40, 0x10, 0xc0, 0x1f, 0x40, 0x00, 0xc0, 0x1f, 0x40, 0x00, 0x80, 0x1f, 0x00, 0x10, 0x00, 0x00, /*"m",76*/
0x40, 0x10, 0xc0, 0x1f, 0x80, 0x10, 0x40, 0x00, 0x40, 0x00, 0x40, 0x10, 0x80, 0x1f, 0x00, 0x10, /*"n",77*/
0x00, 0x00, 0x00, 0x07, 0x80, 0x08, 0x40, 0x10, 0x40, 0x10, 0x80, 0x08, 0x00, 0x07, 0x00, 0x00, /*"o",78*/
0x40, 0x40, 0xc0, 0x7f, 0x80, 0x50, 0x40, 0x10, 0x40, 0x10, 0x40, 0x10, 0x80, 0x0f, 0x00, 0x00, /*"p",79*/
0x00, 0x00, 0x80, 0x0f, 0x40, 0x10, 0x40, 0x10, 0x40, 0x10, 0x40, 0x48, 0xc0, 0x7f, 0x00, 0x40, /*"q",80*/
0x40, 0x10, 0x40, 0x10, 0xc0, 0x1f, 0x80, 0x10, 0x40, 0x10, 0x40, 0x00, 0xc0, 0x00, 0x00, 0x00, /*"r",81*/
0x00, 0x00, 0x80, 0x19, 0x40, 0x12, 0x40, 0x12, 0x40, 0x12, 0xc0, 0x0c, 0x00, 0x00, 0x00, 0x00, /*"s",82*/
0x00, 0x00, 0x40, 0x00, 0x40, 0x00, 0xf0, 0x0f, 0x40, 0x10, 0x40, 0x10, 0x00, 0x00, 0x00, 0x00, /*"t",83*/
0x40, 0x00, 0xc0, 0x0f, 0x00, 0x10, 0x00, 0x10, 0x00, 0x10, 0x40, 0x08, 0xc0, 0x1f, 0x00, 0x10, /*"u",84*/
0x40, 0x00, 0xc0, 0x00, 0x40, 0x07, 0x00, 0x18, 0x00, 0x04, 0x40, 0x03, 0xc0, 0x00, 0x40, 0x00, /*"v",85*/
0x40, 0x00, 0xc0, 0x03, 0x00, 0x1c, 0xc0, 0x03, 0x00, 0x1c, 0xc0, 0x03, 0x40, 0x00, 0x00, 0x00, /*"w",86*/
0x00, 0x00, 0x40, 0x10, 0xc0, 0x18, 0x00, 0x17, 0x40, 0x07, 0xc0, 0x18, 0x40, 0x10, 0x00, 0x00, /*"x",87*/
0x40, 0x40, 0xc0, 0x40, 0x40, 0x47, 0x00, 0x38, 0x00, 0x0c, 0x40, 0x03, 0xc0, 0x00, 0x40, 0x00, /*"y",88*/
0x00, 0x00, 0xc0, 0x10, 0x40, 0x18, 0x40, 0x16, 0x40, 0x11, 0xc0, 0x10, 0x40, 0x18, 0x00, 0x00, /*"z",89*/
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x7e, 0x3f, 0x02, 0x20, 0x00, 0x00, 0x00, 0x00, /*"{",90*/
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x7f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*"|",91*/
0x00, 0x00, 0x00, 0x00, 0x02, 0x20, 0x7e, 0x3f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /*"}",92*/
0x00, 0x00, 0x06, 0x00, 0x01, 0x00, 0x01, 0x00, 0x02, 0x00, 0x04, 0x00, 0x04, 0x00, 0x03, 0x00, /*"~",93*/
0x00, 0x00, 0xFE, 0x7F, 0x06, 0x60, 0x0A, 0x50, 0x12, 0x48, 0x22, 0x44, 0x42, 0x42, 0x82, 0x41, /*汉字无字提示前半框*/
0x82, 0x41, 0x42, 0x42, 0x22, 0x44, 0x12, 0x48, 0x0A, 0x50, 0x06, 0x60, 0xFE, 0x7F, 0x00, 0x00, /*汉字无字提示后半框*/
};

extern FIL hz_fd;//汉字文件句柄变量
const HZ_FLAGS *font_flags = (const HZ_FLAGS *)FONT_ADDRESS_START;
const FONT_STR *font_16_16=(const FONT_STR *)(FONT_ADDRESS_START+32);
static u16 hz_cnt=0xFFFF;
u16 get_hz_count(void)
{
    s32 val;

    if(hz_cnt!=font_flags->hz_cnt)  //用于下载新字库后，及时更新汉字个数
    {
        hz_cnt=0xFFFF;
    }

    if(hz_cnt==0xFFFF)
    {
        //考虑字库文件会补齐成4字节对齐
        val = font_flags->filelen - (font_flags->hz_cnt*34+32);
        if(val>=0&&val<4)   //最多补3个00，字库文件标记正确否
        {
            hz_cnt = font_flags->hz_cnt;
        }
        else
        {
            //无字库文件，返回0个汉字
            return 0;   
        }
    }
    return hz_cnt;
}

//递归算法
int recurbinary(const FONT_STR *p, u16 code, int low, int high)
{
    int mid;
    if(low > high)
        return -1;
    
    mid = (low + high)/2;
    if(p[mid].char_code == code)
        return mid;
    else if(p[mid].char_code > code)
        return recurbinary(p,code,low,mid -1);
    else
        return recurbinary(p,code,mid + 1,high);
}
/*	
	description: find dot data from data saved in mcu
	input: 	char_code - chinese code to find
			dot_buffer - buffer to save dot data found
			dot_buffer_size - size of buffer to save dot data
	return: TRUE if found, or FALSE
*/

BOOL drv_lcd_find_dot_interdata_16x16(u32 char_code, u8 *dot_buffer, u8 dot_buffer_size)
{
	int i;
	u16 cnt;

	if(dot_buffer_size != 32)
		return FALSE;
	
	cnt=get_hz_count();
   
    i=recurbinary(font_16_16, char_code, 0, cnt);

    if(i>=0)
    {
        memcpy(dot_buffer, font_16_16[i].dot_data, 32);
        return TRUE;
    }

	return FALSE;
}
BOOL drv_lcd_find_dot_data_qr(u8 *char_code, u8 *dot_buffer, u8 dot_buffer_size)
{
    u32 ziku_offset;
    u8 tmp1,tmp2;
    u8 real_len;//读出数据的真实长度
    
	if(dot_buffer_size != 32)
		return FALSE;
	
    /*if(char_code >= 0xA1A1)
    {
        tmp1 = (char_code>>8)&0xff;
        tmp2 = (char_code)&0xff;
        
        ziku_offset= ((tmp1 - 0xA1)*94 + (tmp2 - 0xA1));
        ziku_offset = ziku_offset*32;//计算出待显示汉字在字库对应位置
    }*/
    if(char_code[0] >= 0xA1)
    {
        tmp1 = (char_code[0])&0xff;
        tmp2 = (char_code[1])&0xff;
        
        ziku_offset= ((tmp1 - 0xA1)*94 + (tmp2 - 0xA1));
        ziku_offset = ziku_offset*32;//计算出待显示汉字在字库对应位置
    }
    else
    {
        log_font("font,err\r\n");
        return FALSE;
    }
    if(dev_QR_lcd_is_open() == 1)
    {
        f_lseek(&hz_fd, ziku_offset);//定位偏移
        f_read(&hz_fd,dot_buffer,32,&real_len);
    }
    else
    {
        uart_printf("字库文件还没有打开\n");
        return FALSE;
    }
    //dev_spiflash_read(FS_HANZI_ZIKU_ADDR+ziku_offset,dot_buffer,32);
    return TRUE;
}


void hz_cross2clumn(u8* pin,u8* pout,u8 len);
BOOL drv_lcd_find_dot_data_16x16(u32 char_code, u8 *dot_buffer, u8 dot_buffer_size)
{
//	int i,j,a;
//	u16 cnt;
    u32 ziku_offset;
    u8 data[32];
    u8 tmp1,tmp2;
    
	if(dot_buffer_size != 32)
		return FALSE;
	
    if(char_code >= 0xA1A1)
    {
        tmp1 = (char_code>>8)&0xff;
        tmp2 = (char_code)&0xff;
        
        ziku_offset= ((tmp1 - 0xA1)*94 + (tmp2 - 0xA1));
        ziku_offset = ziku_offset*32;//计算出待显示汉字在字库对应位置
        
        
    }
    else
    {
        log_font("font,err\r\n");
        return FALSE;
    }

    dev_spiflash_read(FS_HANZI_ZIKU_ADDR+ziku_offset,data,32);
    //memset(data,0x00,32);
    //data[0] = 0xff;
    //data[16] = 0xff;
    //printf_format(data,32);
    memset(dot_buffer,0x00,32);

    /*a = 0;
    for(j = 0;j<16;)
    {
        for(i = 0;i<8;i++)
        {
            dot_buffer[j] >>= 1;
            dot_buffer[j] |= ((data[i*2]<<(a))&0x80); 
        }
        j++;
        for(i = 0;i<8;i++)
        {
            dot_buffer[j] >>= 1;
            dot_buffer[j] |= ((data[i*2+16]<<(a))&0x80); 
        }
        j++;a++;
    }
    a = 0;
    for(j = 0;j<16;)
    {
        for(i = 0;i<8;i++)
        {
            dot_buffer[j+16] >>= 1;
            dot_buffer[j+16] |= ((data[i*2+1]<<(a))&0x80); 
        }
        j++;
        for(i = 0;i<8;i++)
        {
            dot_buffer[j+16] >>= 1;
            dot_buffer[j+16] |= ((data[i*2+16+1]<<(a))&0x80); 
        }
        j++;a++;
    } */  
    //printf_format(dot_buffer,32);
    hz_cross2clumn(data,dot_buffer,32);
    return TRUE;


	//return FALSE;
}


//将205的ascii的纵库转为横库
void ascii_clumn2cross(u8* pin,u8* pout,u8 len)
{
    u8 i,j;//,m,tmp;
    u8 data[32];
	
		for(j = 0;j<8;j++)
    {
        data[7-j] = 0;
        for(i = 0;i<8;i++)
        {
            data[7-j] <<= 1;
            data[7-j] |= (pin[i*2]>>(7-j))&0x01; 
        }     
    }
    for(j = 0;j<8;j++)
    {
        data[15-j] = 0;
        for(i = 0;i<8;i++)
        {
            data[15-j] <<= 1;
            data[15-j] |= (pin[i*2+1]>>(7-j))&0x01; 
            
        }     
    }
    memcpy(pout,data,16);
}

//将205的汉字纵库转为横库
void hz_clumn2cross(u8* pin,u8* pout,u8 len)
{
    u8 i,j,m;//,tmp;
    u8 data[32];
	
    memset(data,0x00,32);
    m = 0;
	for(j = 0;j<16;j++)
    {
        for(i = 0;i<8;i++)
        {
            data[j] <<= 1;
            data[j] |= (pin[i*2]>>(m))&0x01; 
        } 
        j++;        
        for(i = 0;i<8;i++)
        {
            data[j] <<= 1;
            data[j] |= (pin[i*2+16]>>(m))&0x01; 
        }   
        m++;
    }
    m = 0;
    for(j = 0;j<16;j++)
    {
        for(i = 0;i<8;i++)
        {
            data[j+16] <<= 1;
            data[j+16] |= (pin[i*2+1]>>(m))&0x01; 
        }  
        j++;        
        for(i = 0;i<8;i++)
        {
            data[j+16] <<= 1;
            data[j+16] |= (pin[i*2+16+1]>>(m))&0x01; 
        } 
        m++;
                
    }
    
    memcpy(pout,data,32);
}
//将标准横库转为纵库
void hz_cross2clumn(u8* pin,u8* pout,u8 len)
{
    u8 i,j,a;//,tmp;
    u8 data[32];
	
    memset(data,0x00,32);
    a = 0;
    for(j = 0;j<16;)
    {
        for(i = 0;i<8;i++)
        {
            pout[j] >>= 1;
            pout[j] |= ((pin[i*2]<<(a))&0x80); 
        }
        j++;
        for(i = 0;i<8;i++)
        {
            pout[j] >>= 1;
            pout[j] |= ((pin[i*2+16]<<(a))&0x80); 
        }
        j++;a++;
    }
    a = 0;
    for(j = 0;j<16;)
    {
        for(i = 0;i<8;i++)
        {
            pout[j+16] >>= 1;
            pout[j+16] |= ((pin[i*2+1]<<(a))&0x80); 
        }
        j++;
        for(i = 0;i<8;i++)
        {
            pout[j+16] >>= 1;
            pout[j+16] |= ((pin[i*2+16+1]<<(a))&0x80); 
        }
        j++;a++;
    }
    
}






